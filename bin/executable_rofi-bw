#!/bin/bash

set -euo pipefail

# Configuration
BW_SESSION_FILE="$HOME/.cache/bw-session"
BW_ACCOUNTS_CACHE="$HOME/.cache/bw-accounts"
SESSION_TIMEOUT=3600
CACHE_TIMEOUT=1800  # 30 minutes instead of 5

# Check dependencies
for cmd in bw jq xclip pass; do
    command -v "$cmd" >/dev/null || { echo "$cmd not found" >&2; exit 1; }
done

# Fast session management - skip validation, just try to use
get_session() {
    local session_file="$BW_SESSION_FILE"
    
    # Use existing session if recent
    if [[ -f "$session_file" ]] && [[ $(($(date +%s) - $(stat -c %Y "$session_file"))) -lt $SESSION_TIMEOUT ]]; then
        export BW_SESSION=$(cat "$session_file")
        return 0
    fi
    
    # Get new session
    local password session
    password=$(pass show bitwarden/melvyn) || exit 1
    session=$(echo "$password" | bw unlock --raw) || exit 1
    
    umask 077
    echo "$session" > "$session_file"
    export BW_SESSION="$session"
}

# Optimized account fetching
get_accounts() {
    local cache_file="$BW_ACCOUNTS_CACHE"
    
    # Use cache if recent (30 minutes)
    if [[ -f "$cache_file" ]] && [[ $(($(date +%s) - $(stat -c %Y "$cache_file"))) -lt $CACHE_TIMEOUT ]]; then
        cat "$cache_file"
        return
    fi
    
    # Fetch and process in one go - much faster
    bw list items --search login 2>/dev/null | \
    jq -r --unbuffered '.[] | select(.login.username) | "\(.name) (\(.login.username)) [\(.id)]"' > "$cache_file"
    cat "$cache_file"
}

# Fast field extraction
copy_field() {
    local id="$1" field="$2"
    local value
    
    value=$(bw get "$field" "$id") || exit 1
    echo -n "$value" | xclip -selection clipboard
    
    # Background clipboard clear
    (sleep 30 && echo -n "" | xclip -selection clipboard) &
}

# Extract ID
extract_id() {
    echo "$1" | grep -oE '\[[^]]+\]' | tr -d '[]'
}

# Main
main() {
    get_session
    
    if [[ -n "${1:-}" ]]; then
        local id
        id=$(extract_id "$1")
        [[ -n "$id" ]] || exit 1
        
        case "$1" in
            *"Copy password"*) copy_field "$id" password ;;
            *"Copy username"*) copy_field "$id" username ;;
            *"Copy URL"*) copy_field "$id" uri ;;
            *"Open URL"*) xdg-open "$(bw get uri "$id")" ;;
            *) 
                echo "ğŸ”‘ Copy password [$id]"
                echo "ğŸ‘¤ Copy username [$id]"
                local url=$(bw get uri "$id" 2>/dev/null || echo "")
                [[ "$url" =~ ^https?:// ]] && echo "ğŸŒ Open URL [$id]" && echo "ğŸ“‹ Copy URL [$id]"
                ;;
        esac
    else
        get_accounts
    fi
}

main "$@"

#!/bin/bash

set -euo pipefail

readonly BASEDIR="$HOME/mnt"
readonly HOSTS="lmserver"
readonly USERNAME="melvyn"

# Check dependencies
for cmd in rofi pass smbclient notify-send getent; do
    command -v "$cmd" >/dev/null || { echo "$cmd not found" >&2; exit 1; }
done

# Cache password for the session
PASSWORD=""
get_password() {
    if [[ -z "$PASSWORD" ]]; then
        PASSWORD=$(pass show samba/lmserver/melvyn 2>/dev/null) || {
            notify-send "Error" "Failed to retrieve password"
            exit 1
        }
    fi
    echo "$PASSWORD"
}

do_mount() {
    local share="$1"
    local host="${share%/*}"
    local password
    
    password=$(get_password)
    
    local ip
    ip=$(timeout 5 getent hosts "$host" | awk '{print $1}') || {
        notify-send "Error" "Cannot resolve host: $host"
        exit 1
    }
    
    local mount_point="$BASEDIR/$share"
    mkdir -p "$mount_point"
    
    if sudo -n /usr/sbin/mount.cifs -o "ip=$ip,username=$USERNAME,password=$password,uid=$(id -u),gid=$(id -g),forceuid,forcegid" "//$share" "$mount_point"; then
        notify-send "SAMBA" "Mounted $share"
    else
        notify-send "Error" "Failed to mount $share"
        rmdir "$mount_point" 2>/dev/null || true
        exit 1
    fi
}

do_umount() {
    local share="$1"
    local mount_point="$BASEDIR/$share"
    
    if sudo -n /usr/bin/umount "$mount_point"; then
        find "$BASEDIR" -type d -empty -delete 2>/dev/null || true
        notify-send "SAMBA" "Unmounted $share"
    else
        notify-send "Error" "Failed to unmount $share"
        exit 1
    fi
}

list_options() {
    local password
    password=$(get_password)
    
    for host in $HOSTS; do
        local shares
        shares=$(timeout 10 smbclient -U "$USERNAME%$password" -L "//$host" -g 2>/dev/null | grep '^Disk' | cut -d'|' -f2 | sort) || {
            notify-send "Error" "Failed to list shares from $host"
            continue
        }
        
        while IFS= read -r share; do
            [[ -n "$share" ]] || continue
            if grep -q "//$host/$share" /proc/mounts; then
                echo "ðŸ”Œ unmount $host/$share"
            else
                echo "ðŸ“¥ mount $host/$share"
            fi
        done <<< "$shares"
    done
}

main() {
    local choice
    choice=$(list_options | rofi -dmenu -p 'Manage SAMBA shares' -i) || exit 0
    
    case "$choice" in
        *"unmount "*)
            do_umount "${choice#*unmount }"
            ;;
        *"mount "*)
            do_mount "${choice#*mount }"
            ;;
        *)
            notify-send "Error" "Invalid choice: $choice"
            exit 1
            ;;
    esac
}

main "$@"

#!/usr/bin/env bash
set -euo pipefail

# Get session ID safely
get_session() {
    local sid="${XDG_SESSION_ID:-}"
    [[ -z "$sid" ]] && sid=$(loginctl list-sessions --no-header | awk '$3=="'$USER'" {print $1; exit}')
    echo "${sid:-1}"
}

SESSION_ID=$(get_session)

# Configuration
declare -A ITEMS=(
    ["ðŸ”’ Lock"]="loginctl lock-session $SESSION_ID"
    ["ðŸ‘¤ Switch"]="dm-tool switch-to-greeter"
    ["ðŸšª Logout"]="loginctl terminate-session $SESSION_ID"
    ["ðŸ’¤ Suspend"]="systemctl suspend"
    ["ðŸ›Œ Hibernate"]="systemctl hibernate"
    ["ðŸ”„ Reboot"]="systemctl reboot"
    ["âš¡ Shutdown"]="systemctl poweroff"
)

CONFIRM=("ðŸ”„ Reboot" "ðŸšª Logout" "âš¡ Shutdown")
SHOW=("${!ITEMS[@]}")
DRY=false

# Parse args
while [[ $# -gt 0 ]]; do
    case "$1" in
        --dry-run) DRY=true; shift ;;
        --choices) IFS='/' read -ra SHOW <<< "$2"; shift 2 ;;
        --confirm) IFS='/' read -ra CONFIRM <<< "$2"; shift 2 ;;
        *) SELECTION="$*"; break ;;
    esac
done

# Rofi setup
echo -e "\0no-custom\x1ftrue"

if [[ -z "${SELECTION:-}" ]]; then
    echo -e "\0prompt\x1fPower"
    printf '%s\n' "${SHOW[@]}"
else
    for item in "${SHOW[@]}"; do
        if [[ "$SELECTION" == "$item" ]]; then
            # Check if needs confirmation
            for conf in "${CONFIRM[@]}"; do
                if [[ "$item" == "$conf" ]]; then
                    echo -e "\0prompt\x1fConfirm"
                    echo "âœ“ $item"
                    echo "âœ— Cancel"
                    exit 0
                fi
            done
            SELECTION="âœ“ $item"
        fi
        
        if [[ "$SELECTION" == "âœ“ $item" ]]; then
            if [[ "$DRY" == "true" ]]; then
                echo "Would run: ${ITEMS[$item]}" >&2
            else
                ${ITEMS[$item]}
            fi
            exit 0
        fi
    done
    
    [[ "$SELECTION" == "âœ— Cancel" ]] && exit 0
    echo "Invalid: $SELECTION" >&2; exit 1
fi
